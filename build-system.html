
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Build system &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Guidelines for bioconda recipes" href="guidelines.html" />
    <link rel="prev" title="Troubleshooting failed recipes" href="troubleshooting.html" />
<link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet"> 
<link rel="stylesheet" type="text/css" href="_static/font-awesome-4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="_static/style.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jqc-1.12.3/dt-1.10.12/datatables.min.css"/>
<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/jqc-1.12.3/dt-1.10.12/datatables.min.js"></script>

<script type="text/javascript" class="init">
$(document).ready(function() {
    $('#recipestable').DataTable( {
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
    } );
} );
</script>

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="build-system">
<h1>Build system<a class="headerlink" href="#build-system" title="Permalink to this headline">¶</a></h1>
<p>The build system for Bioconda takes recipes and converts them into conda
packages that are uploaded to anaconda.org as well as Docker containers that
are uploaded to quay.io. All of this happens in a transparent way, with all
build logs available for inspection. The code for the build system can be found
in <a class="reference external" href="https://github.com/bioconda/bioconda-utils">bioconda-utils</a>, but parts
are also with the <code class="docutils literal"><span class="pre">bioconda-recipes</span></code> repo. This document serves as
a high-level overview; the code remains the authoritative source on exactly
what happens during a build.</p>
<p>Why so complicated? We have to work within the constraints of conda-build,
Docker, and Travis-CI, while simultaneously supporting the same build system on
a local machine so contributors can test. We also have isolated bioconda-utils
from bioconda-recipes to better facilitate testing of the infrastructure, and
to (one day!) make it general enough that others can use the framework for
their own specific channels. So there are a lot of moving parts that have to be
coordinated, resulting in a complex system. That said, we do have some room to
simplify, and do so where we can.</p>
<p>A GitHub pull request, or any pushed changes to a GitHub pull request, triggers
a new build on Travis-CI. Each build on Travis-CI starts with a fresh VM, so we
need to create the entire bioconda-build system environment from scratch for
each build.</p>
<p>One build can contain mulitple recipes, limited only by the time limit imposed
by Travis-CI (they have generously given us an extended build time). Each build
has the following stages; the relevant files in the relevant repos are
indicated.</p>
<ul>
<li><dl class="first docutils">
<dt>Install necessary packages on the VM</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">bioconda-recipes:</span> <span class="pre">.travis.yml</span></code>: configures setup script and env vars</li>
<li><code class="docutils literal"><span class="pre">bioconda-recipes:</span> <span class="pre">scripts/travis-setup.sh</span></code>: the actual setup script;
ends with adding local channel so that subsequent packages can use
previously built packages as dependencies</li>
<li><code class="docutils literal"><span class="pre">bioconda-recipes:</span> <span class="pre">simulate-travis.py</span></code>: called by the setup script;
this installs miniconda and configures bioconda and conda-forge channels</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Start a build</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">bioconda-recipes:</span> <span class="pre">scripts/travis-run.sh</span></code>: handles different ways
a build could be triggered on travis-ci and handles them appropriately</li>
<li><code class="docutils literal"><span class="pre">bioconda-recipes:</span> <span class="pre">.travis.yml</span></code>: env vars defined here</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Run linting on those changed recipes
- <code class="docutils literal"><span class="pre">bioconda-utils:</span> <span class="pre">bioconda_utils/cli.py</span></code>, <code class="docutils literal"><span class="pre">bioconda_utils/linting.py</span></code></p>
</li>
<li><dl class="first docutils">
<dt>Filter recipes to only focus on recipes that satisfy the following criteria:</dt>
<dd><ul class="first last simple">
<li>changed recently (we use a <code class="docutils literal"><span class="pre">git</span> <span class="pre">diff</span></code> command to identify these
recipes; see <code class="docutils literal"><span class="pre">bioconda-utils:</span> <span class="pre">bioconda_utils/build.py</span></code></li>
<li>not on any blacklists listed in <code class="docutils literal"><span class="pre">config.yaml</span></code></li>
<li>package with that version number and build number does not exist in
bioconda channel (we check the channel for each of the changed recipes)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Download the configured Docker container (currently based on CentOS 6)</dt>
<dd><ul class="first last simple">
<li>default configured in <code class="docutils literal"><span class="pre">bioconda-utils:</span> <span class="pre">docker_utils.py</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Build a new, temporary Docker container</dt>
<dd><ul class="first last simple">
<li>Dockerfile configured in <code class="docutils literal"><span class="pre">bioconda-utils:</span> <span class="pre">docker_utils.py</span></code>; we hope to
move to simply pulling from DockerHub now that our build dependencies are
not changing as often)</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Topologically sort changed recipes, and build them one-by-one in the Docker
container. This runs <code class="docutils literal"><span class="pre">conda-build</span></code> on the recipe while also specifying the
correct environment variables.</p>
<blockquote>
<div><ul class="simple">
<li>The conda-build directory is exported to the docker container to a temp
file and added as a channel. This way, packages built by one container
will be visible to containers building subsequent packages in the same
Travis-CI build.</li>
<li><code class="docutils literal"><span class="pre">bioconda-utils:</span> <span class="pre">docker_utils.py</span></code> specifies the build script that is
run in the container.</li>
<li>At the end of the build, the build script copies the package to the
exported conda-bld directory</li>
<li><code class="docutils literal"><span class="pre">bioconda-recipes:</span> <span class="pre">scripts/env_matrix.yml</span></code>: each unique combination of
env vars defined here will create an independent build</li>
<li>A whitelist of env vars (including those defined in the
<code class="docutils literal"><span class="pre">env_matrix.yml</span></code>) is exported. The whitelist is configured in
<code class="docutils literal"><span class="pre">bioconda-utils:</span> <span class="pre">utils.py</span></code>.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Upon successfully building and testing via <code class="docutils literal"><span class="pre">conda-build</span></code>, the built package
is added to a minimal BusyBox container using <code class="docutils literal"><span class="pre">mulled-build</span></code> (maintained in
<a class="reference external" href="https://github.com/galaxyproject/galaxy-lib">galaxy-lib</a>). This acts as
a more stringent test than <code class="docutils literal"><span class="pre">conda-build</span></code> alone. The BusyBox container
purposefully is missing many system libraries (like libgcc) that may be
present in the CentOS 6 container. Note that it is common for a package to
build in the CentOS 6 container but fail in the BusyBox container. When this
happens, it is often because a dependency needs to be added to the recipe.</p>
</li>
<li><p class="first">Upon successfully testing the package in the BusyBox container, we have a branch point:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>if we are on a pull request:</dt>
<dd><ul class="first last">
<li>report the successful test back to the GitHub PR, at which time it
can be merged into the master branch</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>if we are on the master branch:</dt>
<dd><ul class="first last">
<li>upload the built conda package to anaconda.org</li>
<li>upload the BusyBox container to quay.io</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>As soon as the package is uploaded to anaconda.org, it is available for
installing via <code class="docutils literal"><span class="pre">conda</span></code>. As soon as the BusyBox container is uploaded to
quay.io, it is available for use via <code class="docutils literal"><span class="pre">docker</span> <span class="pre">pull</span></code>.</p>
<div class="section" id="the-bulk-branch">
<h2>The <code class="docutils literal"><span class="pre">bulk</span></code> branch<a class="headerlink" href="#the-bulk-branch" title="Permalink to this headline">¶</a></h2>
<p>Periodically, large-scale maintenance needs to be done on the channel. For
example, when a new version of Bioconductor comes out, we need to update all
<code class="docutils literal"><span class="pre">bioconductor-*</span></code> packages and rebuild them. Or if we change the version of
a pinned package in <code class="docutils literal"><span class="pre">scripts/env.yaml</span></code>, then all packages depending
on that package need to be rebuilt. While our build infrastructure will build
recipes in the correct toplogically sorted order, if there are too many recipes
then Travis-CI will timeout and the build will fail.</p>
<p>Our solution to avoiding builds failing due to timeouts is the special <code class="docutils literal"><span class="pre">bulk</span></code>
branch. This branch is used by the bioconda core team for maintenance and
behaves much like the <code class="docutils literal"><span class="pre">master</span></code> branch in that packages, once successfully
built and tested, are immediately uploaded to anaconda.org. The major
difference is that <code class="docutils literal"><span class="pre">bulk</span></code> does not go through the pull-request-and-review
process in order for packages to be built and uploaded to the channel. As such,
only bioconda core members are able to push to the <code class="docutils literal"><span class="pre">bulk</span></code> branch.</p>
<p>The workflow is to first merge the latest master into <code class="docutils literal"><span class="pre">bulk</span></code> branch and
resolve any conflicts. Then push (often a large number of) changes to the
branch, without opening a PR. Unlike the <code class="docutils literal"><span class="pre">master</span></code> branch, which uses
the shortcut of only checking for recipes in the channel if they have been changed
according to <code class="docutils literal"><span class="pre">git</span></code>, the <code class="docutils literal"><span class="pre">bulk</span></code> branch is configured to do the exhaustive
check against the channel (which can take some time). Any existing recipe that
does not exist in the channel will therefore be re-built. As packages build,
they are uploaded; as they fail, the testing moves on to the next package.  The
<code class="docutils literal"><span class="pre">bulk</span></code> branch runs up until the Travis-CI timeout, at which time the entire
build fails. But since individual packages were uploaded as they are
successfully built, our work is saved and we can start the next build where we
left off. Failing tests are fixed in another round of commits, and these
changes are then pushed to <code class="docutils literal"><span class="pre">bulk</span></code> and the process repeats. Once <code class="docutils literal"><span class="pre">bulk</span></code> is
fully successful, a PR is opened to merge the changes into master.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Available packages</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="contributing.html">Contributing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="contrib-setup.html">One-time setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="contribute-a-recipe.html">Contributing a recipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html">Troubleshooting failed recipes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Build system</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-bulk-branch">The <code class="docutils literal"><span class="pre">bulk</span></code> branch</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="guidelines.html">Guidelines for <code class="docutils literal"><span class="pre">bioconda</span></code> recipes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="linting.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="faqs.html">FAQs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Build system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-bulk-branch">The <code class="docutils literal"><span class="pre">bulk</span></code> branch</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="_sources/build-system.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>